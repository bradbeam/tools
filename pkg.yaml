name: golang
install:
  - make
  - go
dependencies:
  - image: docker.io/autonomy/toolchain:d1f6110
finalize:
  - from: /rootfs
    to: /
steps:
  - sources:
      - url: https://dl.google.com/go/go1.12.8.src.tar.gz
        destination: go1.12.8.src.tar.gz
        sha256: 11ad2e2e31ff63fcf8a2bdffbe9bfa2e1845653358daed593c8c2d03453c9898
        sha512: 193a9b08752aa2479c19f5b56fdfe2296c7e6097e0c583290f0fce754ac7571e2ff345f66b69774d8e22f2caa147a3dc15658148017b09e5e7f49fd4569373d4
      - url: https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gz
        destination: go1.4-bootstrap-20171003.tar.gz
        sha256: f4ff5b5eb3a3cae1c993723f3eab519c5bae18866b5e5f96fe1102f0cb5c3e52
        sha512: 2f65d5035d2b4ae8610c3337e0fcba64692c63953b54bf735f634da3532c6573ed08927865bf068b00a3885663815c5efc7dbd9a1b3d6337c9a0c62168aabca7

    prepare: |
      tar -xzf go1.12.8.src.tar.gz --strip-components=1

    build: |
      export CGO_ENABLED=0
      export GOROOT_BOOTSTRAP="/usr/lib/go"
      export GOROOT_FINAL="/rootfs${TOOLCHAIN}/go"
      cd src
      sh make.bash

    install: |
      export GOROOT_FINAL="/rootfs${TOOLCHAIN}/go"
      rm -rf pkg/obj
      rm -rf pkg/bootstrap
      rm -f pkg/tool/*/api
      find src \( -type f -a -name "*_test.go" \) \
      -exec rm -rf \{\} \+
      find src \( -type d -a -name "testdata" \) \
      -exec rm -rf \{\} \+
      find src -type f -a \( -name "*.bash" -o -name "*.rc" -o -name "*.bat" \) \
      -exec rm -rf \{\} \+

      mkdir -p "${GOROOT_FINAL}"
      mv * "${GOROOT_FINAL}"
